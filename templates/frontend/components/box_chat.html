{% load static%}
<div>

    <span class="chat_popup">
        <i class="fa fa-xs fa-comment chat_icon"></i>
    </span>
    <div class="--dark-theme chat_main chat">
        <div style="display: flex; flex-direction: column; height: 100%;">
            <div class="chat__conversation-board" id="chat-conversation">
                <!-- Chat messages will be added here dynamically -->
            </div>
            <div class="chat__conversation-panel">
                <div class="chat__conversation-panel__container">
                    <input class="chat__conversation-panel__input panel-item" id="chat-input" placeholder="Nhập câu hỏi về sản phẩm âm thanh..." />
                    <button class="chat__conversation-panel__button panel-item btn-icon send-message-button" id="send-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            aria-hidden="true" data-reactid="1036" _>
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

<style>
    /* Bot đang suy nghĩ animation */
    .thinking-dots {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 8px 12px;
    }
    
    .dot {
        background-color: #ccc;
        border-radius: 50%;
        width: 8px;
        height: 8px;
        margin: 0 4px;
        animation: dot-pulse 1.5s infinite ease-in-out;
    }
    
    .dot:nth-child(1) {
        animation-delay: 0s;
    }
    
    .dot:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .dot:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes dot-pulse {
        0%, 100% {
            transform: scale(1);
            opacity: 0.2;
        }
        50% {
            transform: scale(1.2);
            opacity: 1;
        }
    }
    
    /* Vô hiệu hóa button */
    .disabled-button {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    /* Hiệu ứng typing */
    .typing-effect {
        border-right: 2px solid;
        white-space: pre-wrap;
        overflow-wrap: break-word;
        word-break: break-word;
    }
    .chat__conversation-board__message__context{
        background:white;
        padding:10px;
        border-radius: 10px;
    }
    .product-list .chat__conversation-board__message__bubble {
        background-color: #e3f2fd;
        border-left: 4px solid #2196f3;
    }
    
    .store-info .chat__conversation-board__message__bubble {
        background-color: #f3e5f5;
        border-left: 4px solid #9c27b0;
    }
    
    .no-result .chat__conversation-board__message__bubble {
        background-color: #ffebee;
        border-left: 4px solid #f44336;
    }
    
    .brand-info .chat__conversation-board__message__bubble {
        background-color: #e8f5e9;
        border-left: 4px solid #4caf50;
    }
    
    .category-info .chat__conversation-board__message__bubble {
        background-color: #fff8e1;
        border-left: 4px solid #ffc107;
    }
    
    .bot-response {
        margin: 0;
        padding: 0;
    }
    
    .bot-response p {
        margin: 0;
        padding: 8px 0;
    }
    
    .bot-message-content {
        font-size: 14px;
        line-height: 1.5;
        color: #333;
    }
    
    .bot-message-content ul {
        margin: 8px 0;
        padding-left: 20px;
    }
    
    .bot-message-content li {
        margin: 6px 0;
        line-height: 1.4;
    }
    
    .bot-message-content strong,
    .bot-message-content b {
        color: #1976d2;
    }
    
    /* Table styling for comparisons */
    .bot-message-content table {
        border-collapse: collapse;
        width: 100%;
        margin: 10px 0;
    }
    
    .bot-message-content th,
    .bot-message-content td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    
    .bot-message-content th {
        background-color: #f5f5f5;
    }
    
    /* Highlight product names */
    .bot-message-content .product-name {
        color: #1976d2;
        font-weight: 600;
    }
    
    /* Style for prices */
    .bot-message-content .price {
        color: #e53935;
        font-weight: 500;
    }
    
    .typing-effect {
        border-right: 2px solid;
        animation: blink-caret 0.75s step-end infinite;
    }
    
    @keyframes blink-caret {
        from, to { border-color: transparent }
        50% { border-color: #333; }
    }

    /* Thêm CSS cho typing indicator */
    .typing-indicator {
        display: inline-flex;
        align-items: center;
    }
    
    .typing-indicator span {
        height: 8px;
        width: 8px;
        margin: 0 2px;
        background-color: #555;
        border-radius: 50%;
        display: inline-block;
        animation: typing-bounce 1.2s infinite ease-in-out both;
    }
    
    .typing-indicator span:nth-child(1) {
        animation-delay: -0.32s;
    }
    
    .typing-indicator span:nth-child(2) {
        animation-delay: -0.16s;
    }
    
    @keyframes typing-bounce {
        0%, 80%, 100% { transform: scale(0.6); opacity: 0.6; }
        40% { transform: scale(1.0); opacity: 1; }
    }
</style>

<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        const chatConversation = document.getElementById('chat-conversation');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const chat = document.querySelector('.chat_main');
        const chatPopup = document.querySelector('.chat_popup');
        
        // Hiển thị/ẩn chat box
        chatPopup.addEventListener('click', () => {
            chat.style.display = chat.style.display === 'none' || !chat.style.display ? 'flex' : 'none';
        });
        
        // Khởi tạo biến cho trạng thái
        let isProcessing = false;
        
        // Kiểm tra nếu người dùng đã đăng nhập hay chưa
        const isLoggedIn = {% if request.session.user_id %}true{% else %}false{% endif %};
        const userId = {% if request.session.user_id %}{{ request.session.user_id }}{% else %}null{% endif %};
        
        // Nếu người dùng đã đăng nhập, sử dụng tên session riêng biệt
        const chatSessionKey = isLoggedIn ? `chatHistory_${userId}` : 'chatHistory';
        
        // Lấy lịch sử chat từ localStorage hoặc session
        async function getChatHistory() {
            if (isLoggedIn) {
                try {
                    const response = await fetch('/api/get-chat-history/', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'same-origin'
                    });
                    const data = await response.json();
                    return data.chat_history || [];
                } catch (error) {
                    console.error('Error getting chat history:', error);
                    return [];
                }
            } else {
                // Sử dụng localStorage cho người dùng chưa đăng nhập
                return Promise.resolve(JSON.parse(localStorage.getItem(chatSessionKey)) || []);
            }
        }
        
        // Lưu lịch sử chat vào localStorage hoặc session
        function saveChatHistory(history) {
            if (isLoggedIn) {
                fetch('/api/save-chat-history/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ chat_history: history }),
                    credentials: 'same-origin'
                }).catch(error => console.error('Error saving chat history:', error));
            } else {
                // Sử dụng localStorage cho người dùng chưa đăng nhập
                localStorage.setItem(chatSessionKey, JSON.stringify(history));
            }
        }
        
        // Lấy cookie CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Hiển thị lịch sử chat
        async function displayChatHistory() {
            chatConversation.innerHTML = '';
            
            // Lấy lịch sử chat
            const chatHistory = await getChatHistory();
            
            // Nếu không có lịch sử, hiển thị tin nhắn chào mừng
            if (!chatHistory || chatHistory.length === 0) {
                addBotMessage("Xin chào! Tôi là trợ lý ảo về thiết bị âm thanh, tôi có thể giúp bạn tìm kiếm thông tin về các sản phẩm, giá cả, thương hiệu. Bạn cần hỏi gì về thiết bị âm thanh?");
                return;
            }
            
            // Hiển thị các tin nhắn từ lịch sử
            chatHistory.forEach(msg => {
                if (msg.sender === 'user') {
                    addUserMessage(msg.text, false);
                } else {
                    addBotMessage(msg.text, false, false, msg.sources || []);
                }
            });
            
            // Cuộn xuống tin nhắn mới nhất
            scrollToBottom();
        }
        
        // Thêm tin nhắn người dùng vào khung chat
        function addUserMessage(message, saveToHistory = true) {
            const msgContainer = document.createElement('div');
            msgContainer.className = 'chat__conversation-board__message-container reversed';
            
            msgContainer.innerHTML = `
                <div class="chat__conversation-board__message__person">
                    <div class="chat__conversation-board__message__person__avatar">
                        <img src="https://randomuser.me/api/portraits/men/9.jpg" alt="User" />
                    </div>
                    <span class="chat__conversation-board__message__person__nickname">Bạn</span>
                </div>
                <div class="chat__conversation-board__message__context">
                    <div class="chat__conversation-board__message__bubble">
                        <span>${message}</span>
                    </div>
                </div>
            `;
            
            chatConversation.appendChild(msgContainer);
            
            if (saveToHistory) {
                // Lấy lịch sử hiện tại và thêm tin nhắn mới
                getChatHistory().then(chatHistory => {
                    chatHistory.push({
                        sender: 'user',
                        text: message,
                        timestamp: new Date().toISOString()
                    });
                    
                    // Lưu lịch sử đã cập nhật
                    saveChatHistory(chatHistory);
                });
            }
            
            scrollToBottom();
        }
        
        // Thêm tin nhắn bot vào khung chat
        async function addBotMessage(message, saveToHistory = true, withTypingEffect = true, sources = []) {
            const msgContainer = document.createElement('div');
            msgContainer.className = 'chat__conversation-board__message-container';
            
            // Xác định loại tin nhắn
            let messageClass = '';
            if (message.includes('thương hiệu') || message.includes('hãng')) {
                messageClass = 'brand-info';
            } else if (message.includes('danh mục') || message.includes('loại sản phẩm')) {
                messageClass = 'category-info';
            } else if (message.includes('bán chạy') || message.includes('yêu thích')) {
                messageClass = 'product-list';
            } else if (message.includes('Không tìm thấy') || message.includes('lỗi')) {
                messageClass = 'no-result';
            } else {
                messageClass = 'store-info';
            }
            
            // Format message content
            let messageContent = message;
            if (messageContent.includes('\n1.') || messageContent.includes('\n1. ')) {
                messageContent = formatListContent(messageContent);
            }
            
            // Build message HTML
            let html = `
                <div class="chat__conversation-board__message__person">
                    <div class="chat__conversation-board__message__person__avatar">
                        <img src="{% static 'img/ai_image.png' %}" alt="AI Assistant" />
                    </div>
                    <span class="chat__conversation-board__message__person__nickname">AI AGENTS</span>
                </div>
                <div class="chat__conversation-board__message__context">
                    <div class="chat__conversation-board__message__bubble ${messageClass}">
                        <div class="bot-message-content">${withTypingEffect ? '' : messageContent}</div>
                    </div>
                </div>
            `;
            
            // Add product list if sources exist
            if (sources && sources.length > 0) {
                html += `
                    <div class="chat__conversation-board__message__context product-list">
                        <div class="chat__conversation-board__message__bubble">
                            <div class="products-grid">
                                ${sources.map(source => `
                                    <div class="product-item">
                                        <img src="/static/${source.metadata.image_url}" alt="${source.metadata.name}">
                                        <div class="product-info">
                                            <h4>${source.metadata.name}</h4>
                                            <p class="price">${source.metadata.price} VNĐ</p>
                                            <p class="brand">Thương hiệu: ${source.metadata.brand || 'N/A'}</p>
                                            <p class="category">Danh mục: ${source.metadata.category || 'N/A'}</p>
                                            <a href="/product/${source.metadata.product_id}" class="view-detail">Xem chi tiết</a>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            msgContainer.innerHTML = html;
            chatConversation.appendChild(msgContainer);
            
            if (saveToHistory) {
                // Lấy lịch sử hiện tại và thêm tin nhắn mới
                getChatHistory().then(chatHistory => {
                    chatHistory.push({
                        sender: 'bot',
                        text: message,
                        sources: sources,
                        timestamp: new Date().toISOString()
                    });
                    
                    // Lưu lịch sử đã cập nhật
                    saveChatHistory(chatHistory);
                });
            }
            
            scrollToBottom();
            
            if (withTypingEffect) {
                const contentDiv = msgContainer.querySelector('.bot-message-content');
                await applyTypingEffect(contentDiv, messageContent);
            }
        }
        
        // Hàm format nội dung danh sách
        function formatListContent(content) {
            const lines = content.split('\n');
            let formattedContent = '';
            let inList = false;
            
            lines.forEach((line, index) => {
                if (/^\d+\./.test(line.trim())) {
                    if (!inList) {
                        if (index > 0) formattedContent += lines.slice(0, index).join('<br>');
                        formattedContent += '<ul>';
                        inList = true;
                    }
                    formattedContent += `<li>${line.replace(/^\d+\.\s*/, '')}</li>`;
                } else if (inList && line.trim() === '') {
                    formattedContent += '</ul>';
                    inList = false;
                } else if (inList) {
                    formattedContent += `<br>${line}`;
                } else {
                    if (formattedContent) formattedContent += '<br>';
                    formattedContent += line;
                }
            });
            
            if (inList) formattedContent += '</ul>';
            return formattedContent;
        }
        
        // Hiển thị animation "đang suy nghĩ"
        function showThinking() {
            const container = document.createElement('div');
            container.className = 'chat__conversation-board__message-container thinking-container';
            container.innerHTML = `
                <div class="chat__conversation-board__message__person">
                    <div class="chat__conversation-board__message__person__avatar">
                        <img src="{% static 'img/ai_image.png' %}" alt="AI Assistant" />
                    </div>
                    <span class="chat__conversation-board__message__person__nickname">AI AGENTS</span>
                </div>
                <div class="chat__conversation-board__message__context">
                    <div class="chat__conversation-board__message__bubble">
                        <div class="typing-indicator"><span></span><span></span><span></span></div>
                    </div>
                </div>
            `;
            
            chatConversation.appendChild(container);
            scrollToBottom();
            return container;
        }
        
        // Thêm hiệu ứng typing
        async function applyTypingEffect(element, content) {
            element.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            element.innerHTML = content;
            element.classList.remove('typing-effect');
            isProcessing = false;
            enableInput();
        }
        
        // Cuộn xuống tin nhắn mới nhất
        function scrollToBottom() {
            chatConversation.scrollTop = chatConversation.scrollHeight;
        }
        
        // Vô hiệu hóa input khi đang xử lý
        function disableInput() {
            chatInput.disabled = true;
            sendButton.disabled = true;
            sendButton.classList.add('disabled-button');
        }
        
        // Bật lại input khi đã xử lý xong
        function enableInput() {
            chatInput.disabled = false;
            sendButton.disabled = false;
            sendButton.classList.remove('disabled-button');
            chatInput.focus();
        }
        
        // Gửi tin nhắn đến server
        async function sendMessage() {
            const message = chatInput.value.trim();
            
            if (!message || isProcessing) {
                return;
            }
            
            // Đánh dấu đang xử lý
            isProcessing = true;
            
            // Vô hiệu hóa input
            disableInput();
            
            // Thêm tin nhắn người dùng vào chat
            addUserMessage(message);
            
            // Xóa nội dung input
            chatInput.value = '';
            
            // Hiển thị animation đang suy nghĩ
            const thinkingContainer = showThinking();
            
            try {
                // Gọi API chatbot với timeout 20 giây
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 20000);
                
                const response = await fetch('/api/function-calling/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: message }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                thinkingContainer?.remove();
                
                // Kiểm tra nếu response không OK
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Response data:', data);
                
                // Xử lý phản hồi
                if (data.response) {
                    // Loại bỏ các thẻ HTML không cần thiết
                    let answer = data.response;
                    answer = answer.replace(/<\/?code>/g, '').replace(/<\/?answer>/g, '');
                    
                    // Kiểm tra xem có sources không
                    const sources = data.response.sources || [];
                    addBotMessage(answer, true, true, sources);
                } else {
                    // Fallback message
                    const fallbackMessage = 'Xin lỗi, tôi không thể xử lý câu hỏi của bạn lúc này. Vui lòng thử lại sau!';
                    addBotMessage(fallbackMessage);
                }
                
            } catch (error) {
                console.error('Error:', error);
                thinkingContainer?.remove();
                
                // Kiểm tra loại lỗi để hiển thị thông báo phù hợp
                let errorMessage = 'Xin lỗi, tôi không thể kết nối với máy chủ.';
                
                if (error.name === 'AbortError') {
                    errorMessage = 'Yêu cầu đã quá thời gian chờ. Máy chủ đang bận, vui lòng thử lại sau.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Không thể kết nối đến máy chủ. Vui lòng kiểm tra kết nối internet của bạn!';
                } else if (error.message.includes('HTTP error')) {
                    errorMessage = 'Máy chủ đang gặp sự cố. Vui lòng thử lại sau!';
                }
                
                // Hiển thị thông báo lỗi
                addBotMessage(errorMessage);
                
                // Ghi log lỗi để debug
                console.log('Chi tiết lỗi:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
            } finally {
                isProcessing = false;
                enableInput();
            }
        }
        
        // Xử lý sự kiện click vào nút gửi
        sendButton.addEventListener('click', sendMessage);
        
        // Xử lý sự kiện nhấn Enter trong ô input
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Hiển thị lịch sử chat khi tải trang
        displayChatHistory();
    });
</script>